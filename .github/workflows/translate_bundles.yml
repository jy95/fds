name: Translate L10n Java Bundles

permissions:
  contents: write
  pull-requests: write

env:
  TZ: "Europe/Brussels"

on:
  workflow_dispatch:
    inputs:
      tgt_lang:
        description: 'Target language (must be supported by argostranslate)'
        required: true
        type: choice
        options:
          - ar
          - az
          - bg
          - bn
          - ca
          - cs
          - da
          - de
          - el
          - en
          - eo
          - es
          - et
          - eu
          - fa
          - fi
          - fr
          - ga
          - gl
          - he
          - hi
          - hu
          - id
          - it
          - ja
          - ko
          - ky
          - lt
          - lv
          - ms
          - nb
          - nl
          - pl
          - pt
          - ro
          - ru
          - sk
          - sl
          - sq
          - sr
          - sv
          - th
          - tl
          - tr
          - uk
          - ur
          - vi
          - zh

jobs:
  translate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: | 
          pip install -r requirements.txt

      - name: üîç Extract Version from POM
        id: prep
        run: |
          # Extract version and strip -SNAPSHOT suffix for @since tag
          RAW_VERSION=$(grep -oP '(?<=<revision>)(.*?)(?=</revision>)' pom.xml)
          CLEAN_VERSION=$(echo $RAW_VERSION | sed 's/-SNAPSHOT//')
          echo "version=$CLEAN_VERSION" >> $GITHUB_OUTPUT

      - name: ü§ñ Translate Java Resource Bundles
        run: |
          python scripts/translate_bundles.py --tgt "${{ github.event.inputs.tgt_lang }}" --rev "${{ steps.prep.outputs.version }}"
        env:
          SRC_DIR: common

      - name: ü§ñ Translate Java Test Files
        run: |
          python scripts/translate_java_test_strings.py --tgt-lang "${{ github.event.inputs.tgt_lang }}"
        env:
          SRC_DIR: common/src/main/resources

      - name: üíÖ Create Pull Request
        uses: peter-evans/create-pull-request@v8.1.0
        with:
          title: "feat(l10n): Add ${{ github.event.inputs.tgt_lang }} support"
          commit-message: "feat: translate l10n bundles to ${{ github.event.inputs.tgt_lang }}"
          branch: "automated/l10n-translation-${{ github.event.inputs.tgt_lang }}"
          base: main
          draft: true
          body: | 
            ## üåç New Language Support: `${{ github.event.inputs.tgt_lang }}`

            This automated PR adds FHIR translation support for the `${{ github.event.inputs.tgt_lang }}` locale.
            Generated using Argos Translate with recursive ICU parsing to ensure structural integrity.

            ---

            ### üõ†Ô∏è Step 1: Registry & Integration
            To activate this new locale, you need to manually register it in the following files:

            - [ ] **publiccode.yml**: Add the BCP 47 code `${{ github.event.inputs.tgt_lang }}` to the `availableLanguages` list.
            - [ ] **DosageMarkdown.java**: Add the new `Locale` to the supported list.
            - [ ] **LocaleProviderBase.java**: Include the locale in the test provider for coverage.
            - [ ] **R4 AbstractFhirTest.java**: Register for R4 validation.
            - [ ] **R5 AbstractFhirTest.java**: Register for R5 validation.

            ---

            ### üîç Step 2: Quality Review (Compare with Reference)
            Verify translations in `common/src/main/java/io/github/jy95/fds/common/l10n/`:
            
            | Generated File | English Reference (Original) |
            | :--- | :--- |
            | `DosageFields_${{ github.event.inputs.tgt_lang }}.java` | [DosageFields.java](https://github.com/jy95/fds/blob/main/common/src/main/java/io/github/jy95/fds/common/l10n/DosageFields.java) |
            | `EventTiming_${{ github.event.inputs.tgt_lang }}.java` | [EventTiming.java](https://github.com/jy95/fds/blob/main/common/src/main/java/io/github/jy95/fds/common/l10n/EventTiming.java) |
            | `QuantityComparator_${{ github.event.inputs.tgt_lang }}.java` | [QuantityComparator.java](https://github.com/jy95/fds/blob/main/common/src/main/java/io/github/jy95/fds/common/l10n/QuantityComparator.java) |

            ---

            ### üß™ Step 3: Technical Validation
            - [ ] **Build**: Run `./mvnw clean install -DskipTests` to check for compilation issues.
            - [ ] **Tests**: Run `./mvnw test` to ensure `ListResourceBundle` loads `${{ github.event.inputs.tgt_lang }}` correctly.
            - [ ] **ICU Logic**: Double-check that plural forms (`one`, `other`) and select blocks are correctly translated for this language.

            ---
            *Note: This PR is in draft mode. Please review the translation quality before merging.*
