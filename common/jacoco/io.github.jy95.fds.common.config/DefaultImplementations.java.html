<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultImplementations.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">FHIR Dosage Support - Common</a> &gt; <a href="index.source.html" class="el_package">io.github.jy95.fds.common.config</a> &gt; <span class="el_source">DefaultImplementations.java</span></div><h1>DefaultImplementations.java</h1><pre class="source lang-java linenums">package io.github.jy95.fds.common.config;

import io.github.jy95.fds.common.bundle.MultiResourceBundleControl;
import io.github.jy95.fds.common.functions.GenericOperations;
import io.github.jy95.fds.common.types.DisplayOrder;
import io.github.jy95.fds.common.types.DoseAndRateExtractor;
import io.github.jy95.fds.common.types.DoseAndRateKey;

import java.math.BigDecimal;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Objects;
import java.util.ResourceBundle;
import java.util.concurrent.CompletableFuture;
import java.util.stream.Collectors;

import com.ibm.icu.number.NumberFormatter;

import org.hl7.fhir.instance.model.api.IBaseExtension;
import org.hl7.fhir.instance.model.api.IPrimitiveType;
import org.hl7.fhir.instance.model.api.IBaseCoding;
import org.hl7.fhir.instance.model.api.IBase;

import lombok.NonNull;

/**
 * Provides default implementations for common operations in the library.
 *
 * @author jy95
 * @since 1.0.0
 */
public final class DefaultImplementations {

    // Define the new package path for resource bundles
    private static final String RESOURCE_PACKAGE = &quot;io.github.jy95.fds.common.l10n.&quot;;

    // Initialize the MultiResourceBundleControl with resource bundle names
<span class="fc" id="L39">    private static final MultiResourceBundleControl BUNDLE_CONTROL = new MultiResourceBundleControl(</span>
            &quot;translations&quot;,
            RESOURCE_PACKAGE + &quot;DosageFields&quot;,
            RESOURCE_PACKAGE + &quot;EventTiming&quot;,
            RESOURCE_PACKAGE + &quot;QuantityComparator&quot;);

    // Default display order list
<span class="fc" id="L46">    public static final List&lt;DisplayOrder&gt; DEFAULT_DISPLAY_ORDER = List.of(</span>
            DisplayOrder.METHOD,
            DisplayOrder.DOSE_QUANTITY,
            DisplayOrder.DOSE_RANGE,
            DisplayOrder.RATE_RATIO,
            DisplayOrder.RATE_QUANTITY,
            DisplayOrder.RATE_RANGE,
            DisplayOrder.DURATION_DURATION_MAX,
            DisplayOrder.FREQUENCY_FREQUENCY_MAX_PERIOD_PERIOD_MAX,
            DisplayOrder.OFFSET_WHEN,
            DisplayOrder.DAY_OF_WEEK,
            DisplayOrder.TIME_OF_DAY,
            DisplayOrder.ROUTE,
            DisplayOrder.SITE,
            DisplayOrder.AS_NEEDED,
            DisplayOrder.BOUNDS_DURATION,
            DisplayOrder.BOUNDS_PERIOD,
            DisplayOrder.BOUNDS_RANGE,
            DisplayOrder.COUNT_COUNT_MAX,
            DisplayOrder.TIMING_EVENT,
            DisplayOrder.TIMING_CODE,
            DisplayOrder.MAX_DOSE_PER_PERIOD,
            DisplayOrder.MAX_DOSE_PER_ADMINISTRATION,
            DisplayOrder.MAX_DOSE_PER_LIFETIME,
            DisplayOrder.ADDITIONAL_INSTRUCTION,
            DisplayOrder.PATIENT_INSTRUCTION);

    // Default separator between each part of &quot;Dosage&quot;
    public static final String DEFAULT_SEPARATOR = &quot; - &quot;;

    /**
     * No constructor for this class
     */
    private DefaultImplementations() {
    }

    /**
     * Selects a ResourceBundle for the specified locale using a
     * MultiResourceBundleControl.
     *
     * @param locale the locale for which the ResourceBundle is desired.
     * @return the aggregated ResourceBundle for the specified locale.
     */
    public static ResourceBundle selectResourceBundle(Locale locale) {
<span class="fc" id="L90">        return ResourceBundle.getBundle(</span>
<span class="fc" id="L91">                BUNDLE_CONTROL.getBaseName(),</span>
                locale,
                BUNDLE_CONTROL);
    }

    /**
     * Formats a BigDecimal quantity number for display.
     *
     * @param locale the locale for formatting.
     * @param value  the BigDecimal value to format.
     * @return the formatted string representation of the quantity number.
     * @since 2.1.0
     */
    public static String formatQuantityNumber(Locale locale, BigDecimal value) {
<span class="nc" id="L105">        return NumberFormatter.withLocale(locale).format(value).toString();</span>
    }

    /**
     * Converts a list of FHIR
     * {@link org.hl7.fhir.instance.model.api.IBaseExtension} objects to a JSON-like
     * string representation.
     *
     * @param extensions the list of
     *                   {@link org.hl7.fhir.instance.model.api.IBaseExtension}
     *                   objects to be converted.
     * @return a {@link java.util.concurrent.CompletableFuture} that resolves to a
     *         JSON-like string representing the extensions.
     * @since 2.1.1
     */
    public static CompletableFuture&lt;String&gt; fromExtensionsToString(
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">            @NonNull List&lt;? extends IBaseExtension&lt;?, ?&gt;&gt; extensions) {</span>
<span class="fc" id="L122">        return CompletableFuture.supplyAsync(() -&gt; {</span>

<span class="fc" id="L124">            return extensions</span>
<span class="fc" id="L125">                    .stream()</span>
<span class="fc" id="L126">                    .map(ext -&gt; {</span>

<span class="nc" id="L128">                        StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L129">                        sb.append(&quot;{&quot;);</span>

<span class="nc" id="L131">                        var hasUrl = Objects.nonNull(ext.getUrl());</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                        if (hasUrl) {</span>
<span class="nc" id="L133">                            sb</span>
<span class="nc" id="L134">                                    .append(&quot;\&quot;url\&quot;:\&quot;&quot;)</span>
<span class="nc" id="L135">                                    .append(ext.getUrl())</span>
<span class="nc" id="L136">                                    .append(&quot;\&quot;&quot;);</span>
                        }

<span class="nc" id="L139">                        var hasValue = Objects.nonNull(ext.getValue());</span>
<span class="nc bnc" id="L140" title="All 4 branches missed.">                        if (hasUrl &amp;&amp; hasValue) {</span>
<span class="nc" id="L141">                            sb.append(&quot;,&quot;);</span>
                        }

<span class="nc bnc" id="L144" title="All 4 branches missed.">                        if (hasValue &amp;&amp; ext.getValue() instanceof IPrimitiveType&lt;?&gt; valuIPrimitiveType) {</span>
<span class="nc" id="L145">                            sb</span>
<span class="nc" id="L146">                                    .append(&quot;\&quot;value[x]\&quot;:\&quot;&quot;)</span>
<span class="nc" id="L147">                                    .append(</span>
<span class="nc" id="L148">                                            valuIPrimitiveType.getValueAsString())</span>
<span class="nc" id="L149">                                    .append(&quot;\&quot;&quot;);</span>
                        }

<span class="nc" id="L152">                        sb.append(&quot;}&quot;);</span>
<span class="nc" id="L153">                        return sb.toString();</span>
                    })
<span class="fc" id="L155">                    .collect(Collectors.joining(&quot;, &quot;, &quot;[&quot;, &quot;]&quot;));</span>
        });
    }

    /**
     * Converts a FHIR {@link org.hl7.fhir.instance.model.api.IBaseCoding} to a
     * string representation.
     *
     * @param coding the {@link org.hl7.fhir.instance.model.api.IBaseCoding} to be
     *               converted.
     * @return the display or code of the coding.
     * @since 2.1.1
     */
<span class="nc bnc" id="L168" title="All 2 branches missed.">    public static String fromCodingToString(@NonNull IBaseCoding coding) {</span>
<span class="nc" id="L169">        var display = coding.getDisplay();</span>
<span class="nc" id="L170">        var code = coding.getCode();</span>

<span class="nc" id="L172">        return GenericOperations.conditionalSelect(</span>
<span class="nc" id="L173">                Objects.nonNull(display),</span>
<span class="nc" id="L174">                () -&gt; display,</span>
<span class="nc" id="L175">                () -&gt; code);</span>
    }

    /**
     * Selects a specific dosage and rate field from a list of dose and rate
     * components.
     *
     * @param doseAndRateComponentList the list of dose and rate components.
     * @param doseAndRateKey           the key indicating which field to extract.
     * @param extractorMap             a map of dose and rate keys to their
     *                                 corresponding extractor functions.
     * @param &lt;T&gt;                      the type of the dose and rate component.
     * @param &lt;U&gt;                      the type of the extracted field.
     * @return the extracted field from the first dose and rate component.
     * @since 2.1.3
     */
    public static &lt;T extends IBase, U extends IBase&gt; U selectDosageAndRateField(
            List&lt;T&gt; doseAndRateComponentList,
            DoseAndRateKey doseAndRateKey,
            Map&lt;DoseAndRateKey, DoseAndRateExtractor&lt;T, U&gt;&gt; extractorMap) {
<span class="nc" id="L195">        var doseAndRateExtractor = extractorMap.get(doseAndRateKey);</span>
<span class="nc" id="L196">        var firstRep = doseAndRateComponentList.get(0);</span>
<span class="nc" id="L197">        return doseAndRateExtractor.extract(firstRep);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>